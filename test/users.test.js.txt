const request = require("supertest");
const app = require("../server");      // ðŸ‘ˆ å¼•ç”¨ app ä»¥ä¾¿æ¸¬è©¦ API
const { MongoClient } = require("mongodb");

let connection;
let db;
let testUserId;

beforeAll(async () => {
  connection = await MongoClient.connect(process.env.MONGODB_URL);
  db = connection.db("CarShop");
});

beforeEach(async () => {
  // åœ¨æ¯å€‹æ¸¬è©¦å‰æ¸…ç©º Cars collection
  await db.collection("users").deleteMany({});
});

describe("Users API CRUD Test", () => { 
  // createUser 
  test("POST /users - create a new user", async () => { 
    const response = await request(app) 
    .post("/users") 
    .send({ 
      email: "test@example.com", 
      username: "testuser", 
      name: "Test User", 
      ipaddress: "1.2.3.4" 
    }); 
    expect(response.status).toBe(204); 
    // æŠ“å‡ºå‰›æ–°å¢žçš„ userï¼ˆç”¨ email æ‰¾ï¼‰ 
    const newUser = await db.collection("users").findOne({ email: "test@example.com" }); 
    testUserId = newUser._id.toString(); 
    expect(newUser).toBeDefined(); 
    expect(newUser.username).toBe("testuser"); }); 
  // getSingle 
  test("GET /users/:id - get a single user", async () => { 
    const response = await request(app).get(`/users/${testUserId}`); 
    expect(response.status).toBe(200); 
    expect(response.body).toHaveProperty("email", "test@example.com"); 
  }); 
  // getAll 
  test("GET /users - should return users list", async () => {
      const response = await request(app).get("/users"); 
      expect(response.status).toBe(200); 
      expect(Array.isArray(response.body)).toBe(true); 
  }); 
  // updateUser 
  test("PUT /users/:id - update user", async () => { 
    const response = await request(app) 
    .put(`/users/${testUserId}`) 
    .send({ 
      email: "updated@example.com", 
      username: "updatedUser", 
      name: "Updated User", 
      ipaddress: "5.6.7.8" }); 
      expect(response.status).toBe(204); 
  }); 
  // deleteUser 
  test("DELETE /users/:id - delete user", async () => { 
    const response = await request(app).delete(`/users/${testUserId}`); 
    expect(response.status).toBe(204); 
  }); 
});

afterAll(async () => {
  await connection.close();  // é—œé–‰è³‡æ–™åº«é€£ç·š
});
